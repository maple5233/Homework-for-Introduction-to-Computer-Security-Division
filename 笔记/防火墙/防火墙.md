[TOC]

# 防火墙

## 概述

+ 防火墙是一种高级访问控制设备，置于不同网络安全域之间的一系列部件的组合，它是不同网络安全域间通信流的唯一通道，能根据企业有关的安全政策控制（允许、拒绝、监视、记录）进出网络的访问行为。
+ 防火墙可能是一台专属的硬件或是架设在一般硬件上。

## 功能

+ 隔离网络，通过将网络划分成不同的区域，制定出不同区域之间的访问控制策略来控制不同信任程度区域间传送的数据流。
+ 支援第三方认证服务器
+ 与 IDS 的安全联动
+ 与病毒服务器的安全联动
+  双地址路由功能
+ IP与MAC（用户）的绑定
+ 对DHCP应用环境的支持
+ 对长连接应用的支持
+ MAP (端口映射)
+ NAT (地址转换)

## 分类

以作用的TCP/IP堆栈区分，主要分为网络层防火墙和应用层防火墙两种，但也有些防火墙是同时运作于网络层和应用层。

### 网络层防火墙

+ 网络层防火墙可视为一种 **IP 数据包过滤器**，运作在底层的TCP/IP协议堆栈上。我们可以以枚举的方式，只允许匹配特定规则的数据包通过，其余的一概禁止穿越防火墙。这些规则通常可以经由管理员定义或修改，不过某些防火墙设备可能只能应用内置的规则。
+ 我们也能以另一种较宽松的角度来制定防火墙规则，只要数据包不匹配任何一项“否定规则”就予以放行。现在的操作系统及网络设备大多已内置防火墙功能。
+ 较新的防火墙能利用数据包的多样属性来进行过滤，例如：来源 IP 地址、来源端口号、目的 IP 地址或端口号、服务类型(如 HTTP 或是 FTP)。也能经由通信协议、TTL 值、来源的网域名称或网段...等属性来进行过滤。

### 应用层防火墙

+ 应用层防火墙是在TCP/IP堆栈的“应用层”上运作，**使用浏览器时所产生的数据流或是使用 FTP 时的数据流都是属于这一层。**
+ 应用层防火墙可以拦截进出**某应用程序**的所有数据包，并且封锁其他的数据包(通常是直接将数据包丢弃)。理论上，这一类的防火墙可以完全阻绝外部的数据流进受保护的机器里。
+ 防火墙借由监测所有的数据包并找出不符规则的内容，可以防范电脑蠕虫或是木马程序的快速蔓延。实际上，这个方法繁复（因软件种类极多），所以大部分防火墙都不会考虑以这种方法设计。
+ 现有支持*深度分组检测*的现代防火墙均可扩展成入侵预防系统（IPS），用户身份集成（用户ID与IP或MAC地址绑定），和Web应用防火墙（WAF）。
+ 通常又可以分成以网络为基础的应用防火墙与以主机为基础的应用防火墙二者。

#### 入侵预防系统

**入侵预防系统**（英语：Intrusion Prevention System，缩写为IPS），是计算机网络安全设施，是对防病毒软件和防火墙的补充。入侵预防系统是一部能够监视网络或网络设备的网络数据传输行为的计算机网络安全设备，能够即时的中断、调整或隔离一些不正常或是具有伤害性的网络数据传输行为。

### 代理服务

+ 代理（Proxy）设备（硬件或软件）也能像应用程序一样回应输入数据包（例如连接要求），同时封锁其他的数据包，达到**类似于防火墙**的效果。
+ 代理会使从外部网络窜改一个内部系统更加困难，且只要对于代理有良好的设置，即使内部系统出现问题也不一定会造成安全上的漏洞。
+ 相反地，入侵者也许劫持一个公开可及的系统和使用它作为代理人为他们自己的目的；代理人伪装作为那个系统对其它内部机器。当对内部地址空间的用途增加安全，破坏者也许仍然使用方法譬如IP欺骗试图通过数据包对目标网络。
+ 防火墙经常有网络地址转换(NAT) 的功能，并且主机被保护在防火墙之后共同地使用所谓的“私人地址空间”。

## 防火墙架构

### 主机型防火墙

+ 此防火墙需有两张网卡，一张与互联网连接，另一张与内部网连接


+ 如此互联网与内部网的通道无法直接接通，所有数据包都需要通过主机发送。

### 双闸型防火墙

+ 此防火墙除了主机型防火墙的两张网卡外，另安装应用服务转送器的软件
+ 所有网络数据包都须经过此软件检查，此软件将过滤掉不被系统所允许的数据包。

### 屏障单机型防火墙

+ 此防火墙的硬件设备除需要主机外，还需要一个路由器
+ 路由器需具有数据包过滤的功能，主机则负责过滤及处理网络服务要求的数据包
+ 当互联网的数据包进入屏障单机型防火墙时，路由器会先检查此数据包是否满足过滤规则，再将过滤成功的数据包，转送到主机进行网络服务层的检查与发送。

### 屏障子网域型防火墙

+ 此防火墙借由多台主机与两个路由器组成，电脑分成两个区块，屏障子网域与内部网
+ 数据包经由以下路径，第一个路由器->屏障子网域->第二路由器->内部网
+ 此设计因有阶段式的过滤功能，因此两个路由器可以有不同的过滤规则，让网络数据包更有效率。
+ 若一数据包通过第一过滤器数据包，会先在屏障子网域进行服务处理，若要进行更深入内部网的服务，则要通过第二路由器过滤。

## 缺点

+ 容易造成网络交通的瓶颈。例如在攻击性数据包出现时，攻击者会不时寄出数据包，让防火墙疲于过滤数据包，而使一些合法数据包软件亦无法正常进出防火墙。
+ 无法过滤内部网络的数据包。因此若有人从内部网络攻击时，防火墙没有作用。
+ 而电脑本身的操作系统亦可能因一些系统漏洞，使入侵者可以利用这些漏洞绕过防火墙过滤，从而入侵电脑。
+ 防火墙无法有效阻挡病毒攻击，尤其是隐藏在数据中的病毒。

## 性能指标

### 吞吐量

1. 定义：在不丢包的情况下能够达到的最大速率衡量标准
2. 吞吐量作为衡量防火墙性能的重要指标之一,吞吐量小就会造成网络新的瓶颈，以至影响到整个网络的性能

### 延时

1. 定义：入口处输入帧最后1个比特到达至出口处输出帧的第1个比特输出所用的时间间隔
2. 衡量标准：防火墙的时延能够体现它处理数据的速度 

### 丢包率

1. 定义：在连续负载的情况下，防火墙设备由于资源不足应转发但却未转发的帧百分比 
2. 衡量标准：防火墙的丢包率对其稳定性、可靠性有很大的影响 

### 背靠背

1. 定义：从空闲状态开始，以达到传输介质最小合法间隔极限的传输速率发送相当数量的固定长度的帧，当出现第一个帧丢失时，发送的帧数。
2. 衡量标准：背靠背包的测试结果能体现出被测防火墙的缓冲容量，网络上经常有一些应用会产生大量的突发数据包（例如：备份，路由更新等），而且这样的数据包的丢失可能会产生更多的数据包，强大缓冲能力可以减小这种突发对网络造成的影响

## 防火墙安全性

### 抗DOS/DDOS攻击-----SYN代理

+  在服务器和外部网络之间部署代理服务器
+ 在收到客户端的Syn包后，防火墙代替服务器向客户端发送Syn/Ack包
  + 如果客户端在一段时间内没有应答或中间的网络设备发回了ICMP错误消息，防火墙则丢弃此状态信息
  + 如果客户端的Ack到达，防火墙代替客户端向服务器发送Syn包，并完成后续的握手最终建立客户端到服务器的连接
+ 通过这种Syn-Cookie技术，保证每个Syn包源的真实有效性，确保服务器不被虚假请求浪费资源，从而彻底防范对服务器的Syn-Flood攻击

## 防火墙的胖与瘦

+ 由于防火墙在网络中所处的重要位置，因此，人们对防火墙可以说是寄予厚望。
+ 现在防火墙正在不断增加各种各样的新功能，因此防火墙正在急剧“长胖”。     
+ “胖”防火墙是指功能大而全的防火墙，它力图将安全功能尽可能多地包含在内，从而成为用户网络的一个安全平台。
+ “瘦”防火墙是指功能少而精的防火墙，它只作访问控制的专职工作，对于综合安全解决方案，则采用多家安全厂商联盟的方式来实现。
+ 胖防火墙的优势：
  + 功能全
  + 控制粒度细
  + 协作能力强
  + 降低采购和管理成本
+ 胖防火墙的不足：
  + 性能降低
  + 自身安全性差
  + 专业性不强，表现为功能模块的拼凑稳定性差，系统越大，BUG越多
  + 配置复杂，不合理的配置会带来更大的安全隐患
+ 瘦防火墙的优势：
  + 性能高
  + 注重核心功能，专业性强
  + 整体安全性更高
  + 配置简单，简化对管理员的专业要求
+ 瘦防火墙的不足：
  + 功能单一
  + 整体防护能力较弱 